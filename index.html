<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <!-- 카카오 인앱 확대/여백/안전영역 대응 -->
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
  <meta name="format-detection" content="telephone=no"/>
  <title>BJJ 스타일 테스트</title>

  <meta property="og:title" content="BJJ 스타일 테스트"/>
  <meta property="og:description" content="세밀 문항으로 내 주짓수 스타일 매칭 + 스파이더차트"/>
  <meta name="twitter:card" content="summary"/>

  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>

  <style>
    /* ===== 글로벌 리셋 & 인앱 버그 대응 ===== */
    html, body { height: 100%; width: 100%; margin: 0; padding: 0; -webkit-text-size-adjust: 100%; }
    body { font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; overflow-x: hidden; }
    *, *::before, *::after { box-sizing: border-box; max-width: 100%; }
    /* 최신 뷰포트 유닛 + iOS 폴백 */
    .vh-full { min-height: 100dvh; }
    @supports (-webkit-touch-callout: none) {
      .vh-full { min-height: -webkit-fill-available; }
    }
    /* 안전영역 패딩 */
    .safe-area { padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right); padding-bottom: env(safe-area-inset-bottom); }

    /* 유틸 */
    .glass { backdrop-filter: blur(8px); }
    .chip { display:inline-flex; align-items:center; border:1px solid #e5e7eb; border-radius:9999px; padding:0.25rem 0.75rem; font-size:0.75rem; line-height:1rem; font-weight:500; color:#374151; background:#fff; }
    canvas { display:block; height:auto !important; }
  </style>
</head>
<body>
  <!-- 고정 배경 레이어: 화면 전체를 항상 덮도록 -->
  <div id="bg" class="fixed inset-0 -z-10 bg-gradient-to-b from-gray-50 to-white"></div>

  <div id="root" class="vh-full safe-area"></div>

  <script type="text/babel" data-presets="env,react">
    const { useMemo, useState, useEffect, useRef } = React;

    /* ============ Error Boundary ============ */
    class ErrorBoundary extends React.Component {
      constructor(p){ super(p); this.state={hasError:false}; }
      static getDerivedStateFromError(){ return {hasError:true}; }
      componentDidCatch(err, info){ console.error(err, info); }
      render(){
        if(!this.state.hasError) return this.props.children;
        return (
          <div className="p-4 border rounded-2xl bg-red-50 text-red-800">
            <div className="font-bold mb-1">결과 표시 중 문제가 발생했어요.</div>
            <div className="text-sm">아래 버튼으로 처음부터 다시 진행할 수 있습니다.</div>
            <button className="mt-3 px-4 py-2 rounded-xl border" onClick={this.props.onReset}>다시 하기</button>
          </div>
        );
      }
    }

    /* ============ i18n ============ */
    const STR = {
      ko: { title:"주짓수 플레이 스타일 테스트", subtitle:"세밀 문항으로 닮은 선수와 스파이더차트를 확인하세요.",
        start:"시작하기", next:"다음", prev:"이전", submit:"결과 보기", restart:"다시 하기",
        share:"링크 복사", yourResult:"당신과 닮은 스타일", shareVia:"공유하기", copied:"링크를 복사했습니다.",
        yourStyle:"당신의 플레이 해석", athleteStyle:"선수 스타일 한눈에", strengths:"강점 TOP 3", growth:"보완 포인트", whyMatch:"왜 이 선수와 유사할까?" },
      en: { title:"BJJ Play-Style Test", subtitle:"Detailed questions for precise match + spider chart.",
        start:"Start", next:"Next", prev:"Back", submit:"See Result", restart:"Restart",
        share:"Copy Link", yourResult:"Your Matching Style", shareVia:"Share via", copied:"Link copied!",
        yourStyle:"Your Play Interpreted", athleteStyle:"Athlete Highlights", strengths:"Top 3 Strengths", growth:"Growth Areas", whyMatch:"Why this match?" },
      ja: { title:"BJJ スタイル診断", subtitle:"詳細な設問で精密マッチ＋レーダーチャート。",
        start:"開始", next:"次へ", prev:"戻る", submit:"結果を見る", restart:"やり直す",
        share:"リンクをコピー", yourResult:"あなたに近いスタイル", shareVia:"共有", copied:"リンクをコピーしました。",
        yourStyle:"あなたのプレー解釈", athleteStyle:"選手の特徴", strengths:"強み TOP3", growth:"伸びしろ", whyMatch:"なぜこの選手？" },
    };
    const SUPPORTED = ["ko","en","ja"];
    function detectLang() {
      const urlLang = new URLSearchParams(location.search).get("lang");
      if (urlLang && SUPPORTED.includes(urlLang)) return urlLang;
      const langs = navigator.languages || [navigator.language || "en"];
      for (const l of langs) {
        const code = (l||"").toLowerCase().split("-")[0];
        if (SUPPORTED.includes(code)) return code;
      }
      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || "";
      if (tz.includes("Seoul")) return "ko";
      if (tz.includes("Tokyo")) return "ja";
      return "en";
    }

    /* ============ 축, 가중치, 선수/프로필 ============ */
    const AXES = [
      { key:"control",label:{ko:"포지션 컨트롤",en:"Positional Control",ja:"コントロール"} },
      { key:"pressure",label:{ko:"프레셔 패싱",en:"Pressure Passing",ja:"プレッシャー"} },
      { key:"mobility",label:{ko:"모빌리티 패싱",en:"Mobility Passing",ja:"モビリティ"} },
      { key:"scramble",label:{ko:"템포/스크램블",en:"Tempo/Scramble",ja:"テンポ/スクランブル"} },
      { key:"leglock",label:{ko:"레그락",en:"Leglocks",ja:"レッグロック"} },
      { key:"berimbolo",label:{ko:"베림보로",en:"Berimbolo",ja:"ベリンボロ"} },
      { key:"lapel",label:{ko:"라펠/웜",en:"Lapel/Worm",ja:"ラペル/ワーム"} },
      { key:"fundamental",label:{ko:"정석(기본기)",en:"Fundamentals",ja:"基礎"} },
      { key:"wrestling",label:{ko:"레슬/TD",en:"Wrestling/TD",ja:"レスリング/TD"} },
      { key:"backtake",label:{ko:"백 테이크",en:"Back Takes",ja:"バックテイク"} },
      { key:"fronthead",label:{ko:"프론트 헤드록",en:"Front Headlock",ja:"フロントヘッドロック"} },
      { key:"guardret",label:{ko:"가드 리텐션",en:"Guard Retention",ja:"ガードリテンション"} },
      { key:"finish",label:{ko:"피니시 지향",en:"Finish Orientation",ja:"フィニッシュ志向"} },
    ];
    const WEIGHTS = { control:1.15, pressure:1.1, mobility:1.0, scramble:1.0, leglock:1.2, berimbolo:0.9, lapel:0.9, fundamental:1.0, wrestling:1.0, backtake:1.15, fronthead:1.0, guardret:1.0, finish:1.15 };

    const ATHLETES = [
      { id:"gordon", name:"Gordon Ryan", traits:["시퀀스 체계","바디락/니컷","레그락"], pitch:"설계·통제형. 컨트롤과 피니시의 표준을 제시." },
      { id:"kaynan", name:"Kaynan Duarte", traits:["더블골드(ADCC’24)","압박+모빌리티","길로틴/프론트체인"], pitch:"균형+파워. 압박과 각도 전환을 유기적으로 운용." },
      { id:"mica",   name:"Mica Galvão", traits:["하이 템포","피니시 성향","77kg 강자"], pitch:"템포 장악 후 서브미션으로 수렴하는 공격형." },
      { id:"diogo",  name:"Diogo Reis", traits:["-66kg","모빌리티","백테이크"], pitch:"민첩한 전환과 백 점유에 특화." },
      { id:"bodoni", name:"Giancarlo Bodoni", traits:["-88kg","체계적 패싱","컨트롤"], pitch:"디테일 누적으로 우세 쌓는 정돈형." },
      { id:"pena",   name:"Felipe Pena", traits:["+99kg","백 컨트롤","전략"], pitch:"전통적 구조에 최신 트렌드를 접목한 안정형." },
      { id:"nickyrod", name:"Nick Rodriguez", traits:["레슬 탑컨","스크램블","피지컬"], pitch:"레슬 베이스로 상단 압박과 스크램블 지배." },
      { id:"craig",  name:"Craig Jones", traits:["레그락 시스템","K-가드","전술"], pitch:"합리적 레그 체인으로 기회 창출." },
      { id:"luke",   name:"Luke Griffith", traits:["헤비급","New Wave","상체 체인"], pitch:"견고한 컨트롤과 상체 서브 체계." },
      { id:"helena", name:"Helena Crevar", traits:["CJI 우승","다이나믹","서브 위협"], pitch:"젊은 에너지의 지속 압박." },
      { id:"meregali", name:"Nicholas Meregali", traits:["기","탑 컨트롤","서브"], pitch:"교본적 탑 컨트롤의 정점." },
      { id:"tainan", name:"Tainan Dalpra", traits:["기 테크니션","라인·각도","포지셔널"], pitch:"각도·라인으로 공간 창출." },
      { id:"keenan", name:"Keenan Cornelius", traits:["라펠/웜","가드 전환","시스템"], pitch:"라펠 시스템으로 흐름 설계." },
      { id:"rafa",   name:"Rafael Mendes", traits:["DLR/베림보로","백테이크","정밀"], pitch:"정밀 각도로 백 점유." },
      { id:"cobrinha", name:"Rubens “Cobrinha” Charles", traits:["리텐션","백 위협","템포"], pitch:"리텐션→백 체인의 교과서." },
      { id:"mikey",  name:"Mikey Musumeci", traits:["정교 디테일","라이트급","가드 IQ"], pitch:"미세 디테일로 승부보는 테크니션." },
      { id:"tye",    name:"Tye Ruotolo", traits:["공격적 패싱","레슬/스크램블","다이나믹"], pitch:"탑에서 파고드는 공격성." },
      { id:"cade",   name:"Kade Ruotolo", traits:["하이 템포","다스/프론트","다이나믹"], pitch:"끊임없는 템포 압박과 프론트 체인." },
      { id:"roger",  name:"Roger Gracie", traits:["포지셔널","프레셔","정석 피니시"], pitch:"기본기의 왕도." },
      { id:"marcelo",name:"Marcelo Garcia", traits:["버터플라이/엑스","스크램블","초크"], pitch:"타이밍 전환의 달인." },
    ];

    const PROFILES = {
      gordon:{control:9,pressure:8,mobility:7,scramble:6,leglock:10,berimbolo:1,lapel:0,fundamental:8,wrestling:8,backtake:9,fronthead:8,guardret:8,finish:9},
      kaynan:{control:9,pressure:9,mobility:8,scramble:7,leglock:5,berimbolo:2,lapel:2,fundamental:9,wrestling:8,backtake:8,fronthead:9,guardret:8,finish:7},
      mica:{control:7,pressure:6,mobility:8,scramble:9,leglock:6,berimbolo:3,lapel:0,fundamental:7,wrestling:7,backtake:8,fronthead:9,guardret:8,finish:9},
      diogo:{control:7,pressure:5,mobility:9,scramble:9,leglock:5,berimbolo:3,lapel:0,fundamental:8,wrestling:6,backtake:9,fronthead:5,guardret:9,finish:8},
      bodoni:{control:9,pressure:8,mobility:6,scramble:6,leglock:5,berimbolo:2,lapel:0,fundamental:9,wrestling:6,backtake:8,fronthead:6,guardret:8,finish:6},
      pena:{control:9,pressure:8,mobility:6,scramble:6,leglock:4,berimbolo:2,lapel:2,fundamental:9,wrestling:7,backtake:9,fronthead:5,guardret:8,finish:8},
      nickyrod:{control:7,pressure:8,mobility:6,scramble:9,leglock:4,berimbolo:0,lapel:0,fundamental:7,wrestling:10,backtake:7,fronthead:7,guardret:7,finish:5},
      craig:{control:7,pressure:5,mobility:6,scramble:7,leglock:10,berimbolo:3,lapel:0,fundamental:7,wrestling:5,backtake:7,fronthead:6,guardret:8,finish:9},
      luke:{control:8,pressure:7,mobility:6,scramble:6,leglock:5,berimbolo:1,lapel:0,fundamental:8,wrestling:7,backtake:7,fronthead:7,guardret:8,finish:6},
      helena:{control:7,pressure:5,mobility:7,scramble:8,leglock:6,berimbolo:3,lapel:0,fundamental:7,wrestling:5,backtake:8,fronthead:5,guardret:8,finish:8},
      meregali:{control:9,pressure:9,mobility:6,scramble:6,leglock:3,berimbolo:2,lapel:4,fundamental:9,wrestling:7,backtake:8,fronthead:4,guardret:8,finish:8},
      tainan:{control:9,pressure:7,mobility:7,scramble:6,leglock:3,berimbolo:3,lapel:6,fundamental:10,wrestling:6,backtake:8,fronthead:4,guardret:9,finish:7},
      keenan:{control:7,pressure:5,mobility:6,scramble:6,leglock:5,berimbolo:6,lapel:10,fundamental:8,wrestling:4,backtake:8,fronthead:4,guardret:9,finish:6},
      rafa:{control:8,pressure:6,mobility:8,scramble:8,leglock:4,berimbolo:9,lapel:6,fundamental:9,wrestling:6,backtake:10,fronthead:5,guardret:9,finish:9},
      cobrinha:{control:8,pressure:7,mobility:8,scramble:9,leglock:4,berimbolo:6,lapel:5,fundamental:9,wrestling:6,backtake:9,fronthead:6,guardret:10,finish:8},
      mikey:{control:7,pressure:4,mobility:7,scramble:6,leglock:7,berimbolo:7,lapel:5,fundamental:9,wrestling:3,backtake:7,fronthead:4,guardret:9,finish:8},
      tye:{control:6,pressure:7,mobility:8,scramble:9,leglock:6,berimbolo:2,lapel:0,fundamental:7,wrestling:8,backtake:8,fronthead:9,guardret:7,finish:8},
      cade:{control:6,pressure:6,mobility:8,scramble:10,leglock:7,berimbolo:3,lapel:0,fundamental:6,wrestling:8,backtake:8,fronthead:9,guardret:7,finish:9},
      roger:{control:10,pressure:9,mobility:4,scramble:3,leglock:3,berimbolo:0,lapel:4,fundamental:10,wrestling:6,backtake:9,fronthead:4,guardret:8,finish:8},
      marcelo:{control:6,pressure:5,mobility:7,scramble:9,leglock:4,berimbolo:2,lapel:3,fundamental:8,wrestling:5,backtake:9,fronthead:7,guardret:7,finish:9},
    };

    /* ============ 문항 ============ */
    const L = (ko,en,ja)=>({ko,en,ja});
    const Q = []; let qid = 0;
    function add(axis, text, opts){ Q.push({ id: ++qid, axis, text, options: opts }); }

    add("control", L("상위 포지션(사이드/마운트) 고정 능력은?","Top position (side/mount) control?","トップポジションのコントロール力は？"),
      [{label:L("매우 강함","Very strong","非常に強い"),val:10},{label:L("보통","Moderate","普通"),val:5},{label:L("약함","Low","弱い"),val:0}]);
    add("control", L("백 컨트롤에서 훅/시트벨트 유지력은?","Back control retention?","バックコントロールの維持力は？"),
      [{label:L("매우 강함","Very strong","非常に強い"),val:10},{label:L("보통","Moderate","普通"),val:5},{label:L("약함","Low","弱い"),val:0}]);

    add("pressure", L("바디락/프레셔 패싱 비중은?","Bodylock/pressure passing?","ボディロック/プレッシャーパスの割合は？"),
      [{label:L("주 무기","Primary","得意技"),val:10},{label:L("상황별","Situational","状況に応じて"),val:5},{label:L("드뭄","Rare","めったにない"),val:0}]);
    add("mobility", L("토레안도/롱스텝/레그드랙 등 모빌리티 패싱 비중은?","Mobility passing?","モビリティパスの割合は？"),
      [{label:L("주 무기","Primary","得意技"),val:10},{label:L("상황별","Situational","状況に応じて"),val:5},{label:L("드뭄","Rare","めったにない"),val:0}]);
    add("scramble", L("하이 템포 스크램블 선호?","High-tempo scrambles?","ハイテンポのスクランブルは好き？"),
      [{label:L("매우 높음","Very high","非常に高い"),val:10},{label:L("보통","Balanced","普通"),val:5},{label:L("낮음","Low","低い"),val:0}]);
    add("leglock", L("엔트리 다양성(Outside/Inside/K-Guard 등)은?","Leg entry diversity?","レッグエントリーの多様性は？"),
      [{label:L("다양/시스템적","Diverse/Systematic","多様/体系的"),val:10},{label:L("기회형","Opportunistic","機会主義的"),val:5},{label:L("거의 없음","Rare","ほとんどない"),val:0}]);
    add("leglock", L("레그락을 먼저 노리나요(레그→상체 전환 포함)?","Initiate with legs?","最初にレッグロックを狙う？"),
      [{label:L("자주","Often","よくある"),val:10},{label:L("상황별","Sometimes","状況に応じて"),val:5},{label:L("거의 없음","Rare","ほとんどない"),val:0}]);
    add("berimbolo", L("베림보로/변형 사용 빈도는?","Berimbolo usage?","ベリンボロの使用頻度は？"),
      [{label:L("자주","Often","よくある"),val:10},{label:L("가끔","Sometimes","時々"),val:5},{label:L("거의 없음","Rare","ほとんどない"),val:0}]);
    add("lapel", L("라펠/웜/라소 계열 사용 빈도는?(Gi)","Lapel/Worm/Lasso usage?","ラペル/ワーム/ラッソ（Gi）"),
      [{label:L("자주","Often","よくある"),val:10},{label:L("가끔","Sometimes","時々"),val:5},{label:L("거의 없음","Rare","ほとんどない"),val:0}]);
    add("fundamental", L("정석 콤보(암바/삼각/초크) 선호도는?","Classic subs?","定番のサブの好みは？"),
      [{label:L("매우 높음","Very high","非常に高い"),val:10},{label:L("보통","Balanced","普通"),val:5},{label:L("낮음","Low","低い"),val:0}]);
    add("wrestling", L("테이크다운 지향(노기 기준 포함)은?","Takedown emphasis?","テイクダウン志向？"),
      [{label:L("우선","First","優先"),val:10},{label:L("상황별","Situational","状況に応じて"),val:5},{label:L("거의 없음","Rare","ほとんどない"),val:0}]);
    add("backtake", L("가드/패스 중 백 테이크 전환 빈도는?","Back-take transitions?","バックテイクへの移行頻度は？"),
      [{label:L("자주","Often","よくある"),val:10},{label:L("가끔","Sometimes","時々"),val:5},{label:L("드뭄","Rare","めったにない"),val:0}]);
    add("fronthead", L("프론트 헤드록 체인(길로틴/다스) 활용도는?","Front-headlock chain?","フロントヘッドロックの活用度は？"),
      [{label:L("높음","High","高い"),val:10},{label:L("보통","Moderate","普通"),val:5},{label:L("낮음","Low","低い"),val:0}]);
    add("guardret", L("오픈가드 리텐션의 자신감은?","Open-guard retention?","オープンガードのリテンションは？"),
      [{label:L("높음","High","高い"),val:10},{label:L("보통","Moderate","普通"),val:5},{label:L("낮음","Low","低い"),val:0}]);
    add("finish", L("경기 운영 성향은?","Match orientation?","試合の運営傾向は？"),
      [{label:L("공격적 서브미션 추구","Aggressive subs","積極的なサブ狙い"),val:10},
       {label:L("포지션·포인트 우선","Position/points first","ポジション/ポイント優先"),val:0},
       {label:L("상황에 따라 조절","Situational balance","状況次第"),val:5}]);

    const QUESTIONS = Q;

    /* ============ 스코어링 유틸 ============ */
    function weightedCosine(a,b){
      let dot=0,na=0,nb=0;
      for(const k of Object.keys(WEIGHTS)){
        const w=WEIGHTS[k]||1, x=(a[k]||0)*w, y=(b[k]||0)*w;
        dot+=x*y; na+=x*x; nb+=y*y;
      }
      return dot/(Math.sqrt(na||1)*Math.sqrt(nb||1));
    }
    const AXIS_DESC_KO = {
      control:"탑에서 포지션을 고정하며 우세를 누적",
      pressure:"상체·힙 무게로 압박하며 패스 각도 창출",
      mobility:"각도·발놀림으로 빠르게 라인 체인지",
      scramble:"템포 전환과 스크램블에서 우위 노림",
      leglock:"레그 엔트리 다양성과 체계적 연결",
      berimbolo:"베림보로/인버전 기반 각도 전환",
      lapel:"라펠/웜 계열로 흐름을 설계",
      fundamental:"암바·삼각·초크 등 교과서형 서브",
      wrestling:"테이크다운·톱 우선 운영",
      backtake:"백 각도로의 전환·점유",
      fronthead:"길로틴/다스 등 프론트체인",
      guardret:"리텐션·리빌드로 가드 복구",
      finish:"포지션보다 서브에 무게"
    };
    const fmtAxisLabel=(lang,key)=> (AXES.find(a=>a.key===key)?.label[lang]) || key;
    const topKeys=(obj,n=3)=>Object.entries(obj).sort((a,b)=>b[1]-a[1]).slice(0,n).map(([k])=>k);
    const bottomKeys=(obj,n=3)=>Object.entries(obj).sort((a,b)=>a[1]-b[1]).slice(0,n).map(([k])=>k);

    /* ============ 공유 ============ */
    function buildShareURL(platform, text, url) {
      const t = encodeURIComponent(text), u = encodeURIComponent(url);
      if (platform === "line") return `https://line.me/R/msg/text/?${t}%20${u}`;
      if (platform === "whatsapp") return `https://api.whatsapp.com/send?text=${t}%20${u}`;
      if (platform === "facebook") return `https://www.facebook.com/sharer/sharer.php?u=${u}`;
      if (platform === "telegram") return `https://t.me/share/url?url=${u}&text=${t}`;
      if (platform === "x") return `https://twitter.com/intent/tweet?text=${t}&url=${u}`;
      if (platform === "sms") return `sms:?&body=${t}%20${u}`;
      return url;
    }
    function openShare(url){ const w=window.open(url,"_blank","noopener,noreferrer,width=600,height=700"); if(!w) location.href=url; }

    /* ============ App ============ */
    function App(){
      const [lang,setLang]=useState(detectLang());
      const t=STR[lang]||STR.en;

      const [step,setStep]=useState("intro");
      const [qIdx,setQIdx]=useState(0);
      const [answers,setAnswers]=useState([]);
      const [shared,setShared]=useState(null);

      // 공유 링크 파싱
      useEffect(()=>{
        const r = new URLSearchParams(location.search).get("r");
        if(r){ try{ const j=JSON.parse(atob(r)); if(j?.axes){ setShared(j); setStep("result"); } }catch(e){} }
      },[]);

      // 축 평균 계산
      const axes = useMemo(()=>{
        const sum=Object.fromEntries(AXES.map(ax=>[ax.key,0]));
        const cnt=Object.fromEntries(AXES.map(ax=>[ax.key,0]));
        if(shared?.axes) return shared.axes;
        for(const a of answers){
          const q=QUESTIONS.find(x=>x.id===a.id);
          if(q){ sum[q.axis]+=a.val; cnt[q.axis]+=1; }
        }
        const acc={};
        for(const k of Object.keys(sum)) acc[k]=cnt[k]? (sum[k]/cnt[k]) : 0;
        return acc;
      },[answers,shared]);

      // 매칭 선수
      const winnerObj = useMemo(()=>{
        let best=null,score=-1;
        for(const at of ATHLETES){
          const prof=PROFILES[at.id]; if(!prof) continue;
          const sim=weightedCosine(axes,prof);
          if(sim>score||best==null){ score=sim; best=at; }
        }
        return {at:best, sim:score};
      },[JSON.stringify(axes)]);

      function pick(val){
        const q=QUESTIONS[qIdx]; if(!q) return;
        const next=answers.filter(a=>a.id!==q.id).concat({id:q.id, val});
        setAnswers(next);
      }
      function resetAll(){
        setStep("intro"); setQIdx(0); setAnswers([]); setShared(null);
        requestAnimationFrame(()=>window.scrollTo({top:0,behavior:"smooth"}));
      }

      return (
        <div className="max-w-5xl mx-auto px-4 py-10">
          <header className="text-center mb-8">
            <h1 className="text-3xl md:text-5xl font-extrabold tracking-tight">{t.title}</h1>
            <p className="text-gray-600 mt-2">{t.subtitle}</p>
          </header>

          <main className="rounded-3xl shadow-xl bg-white p-6 md:p-10 glass">
            {step==="intro" && (
              <div className="text-center">
                <div className="mt-3 inline-flex items-center gap-2 text-sm text-gray-500">
                  <span>Language</span>
                  <select className="border rounded-xl px-3 py-2" value={lang} onChange={e=>setLang(e.target.value)}>
                    {Object.keys(STR).map(k=>(<option key={k} value={k}>{k}</option>))}
                  </select>
                </div>
                <button className="mt-6 md:mt-8 px-6 py-3 rounded-2xl bg-black text-white hover:opacity-90 transition"
                        onClick={()=>setStep("quiz")}>{t.start}</button>
              </div>
            )}

            {step==="quiz" && (
              <Quiz lang={lang} t={t} qIdx={qIdx} setQIdx={setQIdx} answers={answers} pick={pick} onSubmit={()=>setStep("result")} />
            )}

            {step==="result" && (
              <ErrorBoundary onReset={resetAll}>
                <Result lang={lang} t={t} axes={axes} winner={winnerObj.at} sim={winnerObj.sim} onRestart={resetAll}/>
              </ErrorBoundary>
            )}

            <p className="text-xs text-gray-400 mt-6">© MK Corporation</p>
          </main>
        </div>
      );
    }

    /* ============ Quiz ============ */
    function Quiz({ t, lang, qIdx, setQIdx, answers, pick, onSubmit }){
      const total=QUESTIONS.length;
      const q=QUESTIONS[qIdx]; if(!q) return null;

      const picked=answers.find(a=>a.id===q.id)?.val;
      const pct=Math.round(((qIdx+1)/total)*100);
      const isLast=qIdx===total-1;

      function submitNow(){
        try{
          const hasAny=answers.length>0;
          if(picked==null && !hasAny) return;
          onSubmit(); requestAnimationFrame(()=>window.scrollTo({top:0,behavior:"smooth"}));
        }catch(e){ onSubmit(); }
      }
      function next(){ setQIdx(i=>Math.min(total-1,i+1)); }
      function prev(){ setQIdx(i=>Math.max(0,i-1)); }

      useEffect(()=>{
        function onKey(e){
          if(e.key==="Enter"){
            if(!isLast && picked!=null) next();
            else if(isLast && picked!=null) submitNow();
          }
        }
        window.addEventListener("keydown", onKey);
        return ()=>window.removeEventListener("keydown", onKey);
      },[isLast,picked]);

      return (
        <div>
          <div className="w-full">
            <div className="flex justify-between text-sm text-gray-500 mb-1">
              <span>Q{qIdx+1}</span><span>{pct}%</span>
            </div>
            <div className="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
              <div className="h-full bg-black/80" style={{width:pct+"%"}}/>
            </div>
          </div>

          <h2 className="text-xl md:text-2xl font-bold mt-6">{q.text[lang] || q.text.en}</h2>

          <div className="grid gap-3 mt-4">
            {q.options.map((opt,i)=>(
              <button key={i} type="button" onClick={()=>pick(opt.val)}
                className={"text-left border rounded-2xl p-4 transition " + (picked===opt.val ? "border-black bg-black text-white" : "border-gray-200 hover:border-black")}>
                {opt.label[lang] || opt.label.en}
              </button>
            ))}
          </div>

          <div className="flex justify-between mt-6">
            <button type="button" className="px-4 py-2 rounded-xl border border-gray-300" onClick={prev} disabled={qIdx===0}>{t.prev}</button>
            {!isLast ? (
              <button type="button" className="px-4 py-2 rounded-2xl bg-black text-white disabled:opacity-40" onClick={next} disabled={picked==null}>{t.next}</button>
            ) : (
              <button type="button" className="px-4 py-2 rounded-2xl bg-black text-white disabled:opacity-40" onClick={submitNow} disabled={picked==null && answers.length===0}>{t.submit}</button>
            )}
          </div>
        </div>
      );
    }

    /* ============ 결과 ============ */
    function Result({ t, lang, axes, winner, sim, onRestart }){
      const safeAth = winner || ATHLETES[0];
      const payload = { axes, winner: safeAth.id, ts: Date.now() };
      const url = location.origin + location.pathname + "?lang=" + lang + "&r=" + btoa(JSON.stringify(payload));
      const text = (STR[lang]?.title || STR.en.title) + " — " + (safeAth.name || "");
      const SHARE = {
        line:      buildShareURL("line", text, url),
        whatsapp:  buildShareURL("whatsapp", text, url),
        facebook:  buildShareURL("facebook", text, url),
        telegram:  buildShareURL("telegram", text, url),
        x:         buildShareURL("x", text, url),
        sms:       buildShareURL("sms", text, url),
      };

      const strengths=topKeys(axes,3);
      const growth=bottomKeys(axes,3);
      const prof=PROFILES[safeAth.id]||{};
      const deltas=Object.fromEntries(Object.keys(WEIGHTS).map(k=>[k,(axes[k]||0)-(prof[k]||0)]));
      const plusKeys=topKeys(deltas,2);
      const minusKeys=bottomKeys(deltas,2);

      function summarySentence(){
        const hi=strengths.map(k=>fmtAxisLabel(lang,k)).join(", ");
        const lo=growth.map(k=>fmtAxisLabel(lang,k)).join(", ");
        return `당신은 ${hi}에 강점이 있고, ${lo}는 상대적으로 낮아요.`;
      }
      function shareKakao(){
        const key="6293a9061e25a8cfabaecddf8b4b4d1e"; // 본인 키로 교체
        try{
          if(window.Kakao && !window.Kakao.isInitialized()) window.Kakao.init(key);
          if(window.Kakao?.Share && key!=="YOUR_KAKAO_JAVASCRIPT_KEY"){
            window.Kakao.Share.sendDefault({
              objectType:'feed',
              content:{ title: STR[lang]?.title || STR.en.title, description: safeAth?.name || "", imageUrl:"",
                        link:{ mobileWebUrl:url, webUrl:url } },
              buttons:[{ title:'열어보기', link:{ mobileWebUrl:url, webUrl:url } }]
            });
            return;
          }
        }catch(e){}
        navigator.clipboard?.writeText(url); alert(STR[lang]?.copied || STR.en.copied);
      }
      function shareNative(){
        if(navigator.share){ navigator.share({title:document.title,text, url}).catch(()=>{}); }
        else { navigator.clipboard?.writeText(url); alert(STR[lang]?.copied || STR.en.copied); }
      }

      return (
        <div>
          <h2 className="text-xl md:text-2xl font-extrabold">{t.yourResult}</h2>

          <div className="grid gap-6 mt-4">
            <section className="rounded-2xl border p-4 md:p-6">
              <div className="flex flex-wrap items-center gap-2">
                <span className="text-lg md:text-xl font-bold">{safeAth.name}</span>
                <span className="chip">매칭도 { ((sim ?? 0)*100).toFixed(1) }%</span>
              </div>
              <p className="mt-2 text-gray-700">{safeAth.pitch}</p>
              <div className="mt-3 flex flex-wrap gap-2">
                {safeAth.traits.map((tr,i)=><span key={i} className="chip">{tr}</span>)}
              </div>
            </section>

            <section className="grid md:grid-cols-2 gap-6">
              <div className="rounded-2xl border p-4 md:p-6">
                <h3 className="font-bold">{t.yourStyle}</h3>
                <p className="mt-2 text-gray-700">{summarySentence()}</p>
                <div className="mt-3">
                  <div className="text-sm font-semibold text-gray-800">{t.strengths}</div>
                  <ul className="mt-1 list-disc list-inside text-sm text-gray-700">
                    {strengths.map(k=><li key={k}>{fmtAxisLabel(lang,k)} — {AXIS_DESC_KO[k]||""}</li>)}
                  </ul>
                </div>
                <div className="mt-3">
                  <div className="text-sm font-semibold text-gray-800">{t.growth}</div>
                  <ul className="mt-1 list-disc list-inside text-sm text-gray-700">
                    {growth.map(k=><li key={k}>{fmtAxisLabel(lang,k)} — 루틴화/반복 드릴로 보강 추천</li>)}
                  </ul>
                </div>
                <div className="mt-3">
                  <div className="text-sm font-semibold text-gray-800">{t.whyMatch}</div>
                  <ul className="mt-1 list-disc list-inside text-sm text-gray-700">
                    <li>공통 강점: {strengths.slice(0,2).map(k=>fmtAxisLabel(lang,k)).join(", ")||"—"}</li>
                    <li>당신이 더 높은 축(+): {plusKeys.map(k=>fmtAxisLabel(lang,k)).join(", ")||"없음"}</li>
                    <li>선수가 더 높은 축(−): {minusKeys.map(k=>fmtAxisLabel(lang,k)).join(", ")||"없음"}</li>
                  </ul>
                </div>
              </div>

              <div className="rounded-2xl border p-4 md:p-6">
                <h3 className="font-bold">{t.athleteStyle}</h3>
                <div className="mt-4" aria-label="Radar chart comparing your style to athlete profile">
                  <RadarChart axes={axes} ath={safeAth} lang={lang}/>
                </div>
                <div className="mt-3 text-xs text-gray-500">라벨은 0~100 스케일(내 점수는 문항 평균×10 가중 반영)</div>
              </div>
            </section>

            <section className="rounded-2xl border p-4 md:p-6">
              <div className="text-sm text-gray-600 mb-2">{t.shareVia}</div>
              <div className="flex flex-wrap gap-2">
                <a className="px-3 py-2 rounded-xl bg-[#FEE500] text-black" href="#" onClick={e=>{e.preventDefault(); shareKakao();}}>Kakao</a>
                <a className="px-3 py-2 rounded-xl border" href="#" onClick={e=>{e.preventDefault(); openShare(SHARE.line);}}>LINE</a>
                <a className="px-3 py-2 rounded-xl border" href="#" onClick={e=>{e.preventDefault(); openShare(SHARE.whatsapp);}}>WhatsApp</a>
                <a className="px-3 py-2 rounded-xl border" href="#" onClick={e=>{e.preventDefault(); openShare(SHARE.facebook);}}>Facebook</a>
                <a className="px-3 py-2 rounded-xl border" href="#" onClick={e=>{e.preventDefault(); openShare(SHARE.telegram);}}>Telegram</a>
                <a className="px-3 py-2 rounded-xl border" href="#" onClick={e=>{e.preventDefault(); openShare(SHARE.x);}}>X</a>
                <a className="px-3 py-2 rounded-xl border" href={SHARE.sms}>SMS</a>
                <a className="px-3 py-2 rounded-xl bg-black text-white" href="#" onClick={e=>{e.preventDefault(); shareNative();}}>Share</a>
                <a className="px-3 py-2 rounded-xl border" href="#" onClick={e=>{e.preventDefault(); navigator.clipboard?.writeText(url); alert(STR[lang]?.copied || STR.en.copied); }}>{t.share}</a>
              </div>

              <div className="flex gap-2 mt-4">
                <button className="px-4 py-2 rounded-xl border" onClick={onRestart}>{t.restart}</button>
              </div>
            </section>
          </div>
        </div>
      );
    }

    /* ============ RadarChart ============ */
    function RadarChart({ axes, ath, lang }){
      const canvasRef=useRef(null);
      const chartRef=useRef(null);

      useEffect(()=>{
        const ChartJS=window.Chart; if(!ChartJS||!canvasRef.current) return;
        const prof=PROFILES[ath.id]||{};
        const labels=AXES.map(ax=>ax.label[lang]||ax.label.en);
        const scores=AXES.map(ax=>(axes[ax.key]||0)*10);
        const athScores=AXES.map(ax=>((prof[ax.key]||0))*10);

        const data={ labels, datasets:[
          { label:'나의 스타일', data:scores, backgroundColor:'rgba(54,162,235,0.35)', borderColor:'rgb(54,162,235)', pointBackgroundColor:'rgb(54,162,235)', pointBorderColor:'#fff' },
          { label:`${ath.name} 프로필`, data:athScores, backgroundColor:'rgba(255,99,132,0.35)', borderColor:'rgb(255,99,132)', pointBackgroundColor:'rgb(255,99,132)', pointBorderColor:'#fff' }
        ]};
        const config={ type:'radar', data, options:{
          responsive:true, maintainAspectRatio:false,
          elements:{ line:{ borderWidth:3 } },
          scales:{ r:{ min:0,max:100, ticks:{ display:false, stepSize:25 }, pointLabels:{ font:{ size:12 }, color:'rgb(51,51,51)' } } },
          plugins:{ legend:{ display:true, position:'top' } }
        }};
        if(chartRef.current) chartRef.current.destroy();
        chartRef.current=new ChartJS(canvasRef.current.getContext('2d'), config);
        return ()=>{ if(chartRef.current) chartRef.current.destroy(); };
      },[axes,ath.id,lang]);

      return <div style={{height:'320px',width:'100%'}}><canvas ref={canvasRef}/></div>;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);

    /* ===== 카카오 인앱 특이 확대 방지(보조 스크립트) =====
       일부 단말에서 초기 확대가 걸리는 경우가 있어,
       첫 페인트 직후 스크롤/리사이즈를 유도해 레이아웃을 재계산시킴. */
    requestAnimationFrame(()=>{
      window.scrollTo(0, 1);
      setTimeout(()=>window.scrollTo(0, 0), 50);
    });
  </script>
</body>
</html>
