<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BJJ 스타일 테스트</title>

  <!-- ✅ OG/Twitter 썸네일 -->
  <meta property="og:title" content="BJJ 스타일 테스트"/>
  <meta property="og:description" content="8문항으로 내 주짓수 스타일과 닮은 선수 + 스파이더차트"/>
  <meta property="og:image" content="https://upload.wikimedia.org/wikipedia/commons/0/0e/Gordon_Ryan_2019.jpg"/>
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:image" content="https://upload.wikimedia.org/wikipedia/commons/0/0e/Gordon_Ryan_2019.jpg"/>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React + ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Kakao SDK (선택) -->
  <script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>

  <style>
    body { font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial }
    .glass { backdrop-filter: blur(8px); }
  </style>
</head>
<body class="bg-gradient-to-b from-gray-50 to-white min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useMemo, useState, useEffect, useRef } = React;

    /* =========================
       다국어 & 언어 감지
    ========================== */
    const STR = {
      ko: { title:"주짓수 플레이 스타일 테스트", subtitle:"8문항으로 닮은 선수와 스파이더차트를 확인하세요.",
            start:"시작하기", next:"다음", prev:"이전", submit:"결과 보기", restart:"다시 하기", share:"링크 복사",
            yourResult:"당신과 닮은 스타일", shareVia:"공유하기", copied:"링크를 복사했습니다.",
            kakaoTip:"카카오 전용 버튼은 도메인 등록+JS 키 필요(없으면 링크 공유 사용)" },
      en: { title:"BJJ Play-Style Test", subtitle:"Answer 8 questions to see your match + spider chart.",
            start:"Start", next:"Next", prev:"Back", submit:"See Result", restart:"Restart", share:"Copy Link",
            yourResult:"Your Matching Style", shareVia:"Share via", copied:"Link copied!",
            kakaoTip:"Kakao button needs domain whitelist + JS key (use link share otherwise)" },
      ja: { title:"BJJ スタイル診断", subtitle:"8問で似ている選手とレーダーチャートを表示。",
            start:"開始", next:"次へ", prev:"戻る", submit:"結果を見る", restart:"やり直す", share:"リンクをコピー",
            yourResult:"あなたに近いスタイル", shareVia:"共有", copied:"リンクをコピーしました。",
            kakaoTip:"カカオ共有はドメイン登録とJSキーが必要（無ければリンク共有）" },
    };
    const SUPPORTED = ["ko","en","ja"];
    function detectLang() {
      const urlLang = new URLSearchParams(location.search).get("lang");
      if (urlLang && SUPPORTED.includes(urlLang)) return urlLang;
      const langs = navigator.languages || [navigator.language || "en"];
      for (const l of langs) {
        const code = (l||"").toLowerCase().split("-")[0];
        if (SUPPORTED.includes(code)) return code;
      }
      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || "";
      if (tz.includes("Seoul")) return "ko";
      if (tz.includes("Tokyo")) return "ja";
      return "en";
    }

    /* =========================
       축/가중치(전문가 납득)
    ========================== */
    const AXES = [
      { key:"control",     label:{ko:"컨트롤",      en:"Control",       ja:"コントロール"} },
      { key:"pressure",    label:{ko:"압박",        en:"Pressure",      ja:"プレッシャー"} },
      { key:"scramble",    label:{ko:"스크램블",    en:"Scramble",      ja:"スクランブル"} },
      { key:"leglock",     label:{ko:"레그락",      en:"Leglocks",      ja:"レッグロック"} },
      { key:"berimbolo",   label:{ko:"베림보로",    en:"Berimbolo",     ja:"ベリンボロ"} },
      { key:"fundamental", label:{ko:"기본기",      en:"Fundamentals",  ja:"基礎"} },
      { key:"wrestling",   label:{ko:"레슬링/TD",   en:"Wrestling/TD",  ja:"レスリング/TD"} },
      { key:"mental",      label:{ko:"전략/멘탈",   en:"Strategy/Mental", ja:"戦略/メンタル"} },
    ];
    const WEIGHTS = { control:1.2, pressure:1.1, scramble:1.0, leglock:1.2, berimbolo:0.8, fundamental:1.0, wrestling:0.9, mental:1.0 };

    /* =========================
       이미지 폴백
    ========================== */
    const PH = (name) =>
      `data:image/svg+xml;charset=UTF-8,` +
      encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='900' height='600'>
        <defs><linearGradient id='g' x1='0' x2='1'><stop offset='0%' stop-color='#f3f4f6'/><stop offset='100%' stop-color='#e5e7eb'/></linearGradient></defs>
        <rect width='100%' height='100%' fill='url(#g)'/>
        <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='40' fill='#6b7280' font-family='Arial, Helvetica, sans-serif'>${name}</text>
      </svg>`);

    function SmartImage({ srcs, alt, className }) {
      const arr = Array.isArray(srcs) ? srcs.filter(Boolean) : [srcs];
      const [idx, setIdx] = React.useState(0);
      const curr = arr[idx] || PH(alt || "BJJ");
      return (
        <img
          src={curr}
          alt={alt}
          referrerPolicy="no-referrer"
          className={className}
          onError={() => {
            if (idx < arr.length - 1) setIdx(idx + 1);
            else if (!curr.startsWith("data:")) setIdx(arr.length - 1);
          }}
        />
      );
    }

    /* =========================
       선수 라인업 + 프로필
    ========================== */
    const ATHLETES = [
      { id:"roger",    name:"Roger Gracie",      img:["https://upload.wikimedia.org/wikipedia/commons/2/2f/Roger_Gracie_2014.jpg", PH("Roger Gracie")],
        traits:["포지셔널 도미넌스","프레셔 패싱","정석 피니시"], compliment:"기본기와 안정감으로 경기를 지배하는 타입!" },
      { id:"marcelo",  name:"Marcelo Garcia",    img:["https://upload.wikimedia.org/wikipedia/commons/7/72/Marcelo_Garcia_2009_ADCC.jpg", PH("Marcelo Garcia")],
        traits:["버터플라이/엑스","스크램블","초크 지향"], compliment:"타이밍 장인! 작은 틈으로 흐름을 바꿉니다." },
      { id:"gordon",   name:"Gordon Ryan",       img:["https://upload.wikimedia.org/wikipedia/commons/0/0e/Gordon_Ryan_2019.jpg", PH("Gordon Ryan")],
        traits:["시퀀스 체계","바디락/니컷","레그락"], compliment:"한 수 앞을 읽는 설계자! 시스템으로 상대를 묶습니다." },
      { id:"mikey",    name:"Mikey Musumeci",    img:["https://upload.wikimedia.org/wikipedia/commons/8/83/Mikey_Musumeci_2019.jpg", PH("Mikey Musumeci")],
        traits:["정교한 디테일","각도 만들기","라이트급 테크니션"], compliment:"디테일 장인! 미세한 각도로 끝냅니다." },
      { id:"gabi",     name:"Gabi Garcia",       img:["https://upload.wikimedia.org/wikipedia/commons/5/58/Gabi_Garcia_2013.jpg", PH("Gabi Garcia")],
        traits:["피지컬·테크닉 밸런스","탑 압박","멘탈"], compliment:"존재감과 힘의 조화! 상단에서 주도합니다." },
      { id:"adam",     name:"Adam Wardzinski",   img:["https://upload.wikimedia.org/wikipedia/commons/8/87/Adam_Wardzinski_2019.jpg", PH("Adam Wardzinski")],
        traits:["버터플라이 교본","암드래그·스윕","탑 전환"], compliment:"버터플라이의 교과서! 언밸런스로 기회를 만듭니다." },
      { id:"cade",     name:"Kade Ruotolo",      img:["https://upload.wikimedia.org/wikipedia/commons/2/2d/Kade_Ruotolo_2022.jpg", PH("Kade Ruotolo")],
        traits:["하이 템포","레슬 엔트리·다스","다이나믹"], compliment:"템포의 화신! 끊임없이 몰아붙입니다." },
      { id:"tye",      name:"Tye Ruotolo",       img:["https://upload.wikimedia.org/wikipedia/commons/8/8c/Tye_Ruotolo_2022.jpg", PH("Tye Ruotolo")],
        traits:["공격적 패싱","레슬/스크램블","다이나믹"], compliment:"탑에서 파고드는 공격성으로 흔듭니다." },
      { id:"miyao",    name:"Paulo Miyao",       img:["https://upload.wikimedia.org/wikipedia/commons/9/9a/Paulo_Miyao_2014.jpg", PH("Paulo Miyao")],
        traits:["베림보로 시스템","DLR & 스핀백","백 테이크"], compliment:"회전으로 공간을 여는 베림보로 마스터!" },
      { id:"meregali", name:"Nicholas Meregali", img:["https://upload.wikimedia.org/wikipedia/commons/0/0e/Nicholas_Meregali_2017.jpg", PH("Nicholas Meregali")],
        traits:["프레셔·탑 컨트롤","정석 서브미션","레슬/투사"], compliment:"강력한 탑 컨트롤과 정석의 교본!" },
      { id:"craig",    name:"Craig Jones",       img:[null, PH("Craig Jones")],
        traits:["레그락 체인","오픈 가드","스크램블"], compliment:"레그 체인으로 흐름을 휘어잡는 다이내믹 파이터." },
      { id:"tonon",    name:"Garry Tonon",       img:[null, PH("Garry Tonon")],
        traits:["스크램블","레그락","공격적 전환"], compliment:"폭발적 전환으로 상대를 흔드는 스타일." },
      { id:"pena",     name:"Felipe Pena",       img:[null, PH("Felipe Pena")],
        traits:["백 컨트롤","베이직+모던","전략 운영"], compliment:"전략적 운영과 백 장악에 탁월." },
      { id:"lepri",    name:"Lucas Lepri",       img:[null, PH("Lucas Lepri")],
        traits:["교과서 패싱","컨트롤","기본기"], compliment:"정교한 패싱과 컨트롤의 정석." },
      { id:"jt",       name:"JT Torres",         img:[null, PH("JT Torres")],
        traits:["탑 컨트롤","레슬링/TD","기본기"], compliment:"레슬 기반 탑 운영의 정석." },
      { id:"tainan",   name:"Tainan Dalpra",     img:[null, PH("Tainan Dalpra")],
        traits:["기본기 정밀","탑 컨트롤","하이 퍼포먼스"], compliment:"정밀한 기본기로 경기를 해석." },
      { id:"mica",     name:"Mica Galvão",       img:[null, PH("Mica Galvão")],
        traits:["공격적 피니시","오픈 가드","하이 템포"], compliment:"공격성과 템포로 주도하는 신성." },
      { id:"mayssa",   name:"Mayssa Bastos",     img:[null, PH("Mayssa Bastos")],
        traits:["가드 전환","기술 디테일","전략적"], compliment:"디테일로 템포를 지배." },
      { id:"ffion",    name:"Ffion Davies",      img:[null, PH("Ffion Davies")],
        traits:["탑 압박","레슬/패싱","멘탈"], compliment:"강한 멘탈과 압박으로 경기를 장악." },
    ];

    const PROFILES = {
      roger:{control:10,pressure:9,scramble:3, leglock:2, berimbolo:0, fundamental:10,wrestling:6, mental:8},
      marcelo:{control:6,pressure:5,scramble:9, leglock:3, berimbolo:2, fundamental:8,wrestling:5, mental:7},
      gordon:{control:9,pressure:7,scramble:5, leglock:10,berimbolo:1, fundamental:8,wrestling:6, mental:10},
      mikey:{control:7,pressure:4,scramble:6, leglock:7, berimbolo:6, fundamental:9,wrestling:3, mental:8},
      gabi:{control:8,pressure:9,scramble:4, leglock:2, berimbolo:0, fundamental:7,wrestling:6, mental:7},
      adam:{control:6,pressure:5,scramble:7, leglock:4, berimbolo:3, fundamental:7,wrestling:4, mental:7},
      cade:{control:6,pressure:6,scramble:10,leglock:7, berimbolo:2, fundamental:6,wrestling:8, mental:7},
      tye:{control:6,pressure:7,scramble:9,  leglock:6, berimbolo:2, fundamental:7,wrestling:8, mental:7},
      miyao:{control:6,pressure:3,scramble:7, leglock:3, berimbolo:10,fundamental:8,wrestling:3, mental:7},
      meregali:{control:9,pressure:9,scramble:6,leglock:3, berimbolo:2, fundamental:9,wrestling:7, mental:8},
      craig:{control:6,pressure:5,scramble:8, leglock:10,berimbolo:3, fundamental:6,wrestling:5, mental:7},
      tonon:{control:6,pressure:5,scramble:10,leglock:7, berimbolo:3, fundamental:6,wrestling:6, mental:7},
      pena:{control:8,pressure:7,scramble:6, leglock:4, berimbolo:2, fundamental:8,wrestling:6, mental:8},
      lepri:{control:9,pressure:8,scramble:5, leglock:3, berimbolo:1, fundamental:9,wrestling:6, mental:8},
      jt:{control:8,pressure:7,scramble:6,   leglock:3, berimbolo:2, fundamental:8,wrestling:8, mental:8},
      tainan:{control:9,pressure:8,scramble:6,leglock:3, berimbolo:2, fundamental:10,wrestling:6, mental:8},
      mica:{control:7,pressure:6,scramble:9,  leglock:6, berimbolo:3, fundamental:7,wrestling:7, mental:7},
      mayssa:{control:7,pressure:5,scramble:7,leglock:4, berimbolo:4, fundamental:8,wrestling:4, mental:8},
      ffion:{control:8,pressure:8,scramble:7, leglock:4, berimbolo:2, fundamental:7,wrestling:7, mental:9},
    };

    /* =========================
       질문 (축 1:1)
    ========================== */
    const QUESTIONS = [
      { id:1, axis:"control",     text:{ko:"포지션 컨트롤 성향은?", en:"Positional control?"},
        options:[{label:{ko:"타이트 고정",en:"Tight hold"}, val:10},
                 {label:{ko:"고정/전환 균형",en:"Balanced"}, val:6},
                 {label:{ko:"전환 위주",en:"Flow"}, val:2}] },
      { id:2, axis:"pressure",    text:{ko:"압박 패싱 성향은?", en:"Pressure passing?"},
        options:[{label:{ko:"프레셔/바디락",en:"Pressure/bodylock"}, val:10},
                 {label:{ko:"모빌리티 병행",en:"Mix mobility"}, val:6},
                 {label:{ko:"압박 낮음",en:"Low pressure"}, val:2}] },
      { id:3, axis:"scramble",    text:{ko:"템포/스크램블 성향은?", en:"Tempo/Scramble?"},
        options:[{label:{ko:"항상 하이 템포",en:"High tempo"}, val:10},
                 {label:{ko:"상황별 조절",en:"Situational"}, val:6},
                 {label:{ko:"낮은 템포",en:"Low tempo"}, val:2}] },
      { id:4, axis:"leglock",     text:{ko:"레그락 활용도는?", en:"Leglock usage?"},
        options:[{label:{ko:"시스템적으로 적극",en:"Systematic/high"}, val:10},
                 {label:{ko:"기회가 있으면",en:"Opportunistic"}, val:6},
                 {label:{ko:"거의 안 함",en:"Rarely"}, val:2}] },
      { id:5, axis:"berimbolo",   text:{ko:"베림보로 사용 빈도는?", en:"Berimbolo frequency?"},
        options:[{label:{ko:"자주 사용",en:"Often"}, val:10},
                 {label:{ko:"가끔",en:"Sometimes"}, val:6},
                 {label:{ko:"거의 없음",en:"Rarely"}, val:2}] },
      { id:6, axis:"fundamental", text:{ko:"정석(기본기) 지향도는?", en:"Fundamentals focus?"},
        options:[{label:{ko:"정석 중심",en:"Classics-driven"}, val:10},
                 {label:{ko:"혼합",en:"Mixed"}, val:6},
                 {label:{ko:"최신/창의",en:"Modern/creative"}, val:2}] },
      { id:7, axis:"wrestling",   text:{ko:"레슬링/테이크다운 지향은?", en:"Wrestling/TD?"},
        options:[{label:{ko:"TD 우선",en:"TD-first"}, val:10},
                 {label:{ko:"상황별 병행",en:"Mix TD/guard pull"}, val:6},
                 {label:{ko:"주로 가드풀",en:"Mostly guard pull"}, val:2}] },
      { id:8, axis:"mental",      text:{ko:"전략/멘탈(운영 방식)은?", en:"Strategy/mental?"},
        options:[{label:{ko:"사전 설계·플랜",en:"Pre-planned"}, val:10},
                 {label:{ko:"적응적",en:"Adaptive"}, val:6},
                 {label:{ko:"즉흥적",en:"Improvisational"}, val:2}] },
    ];

    /* =========================
       스코어링: 가중 코사인
    ========================== */
    function weightedCosine(a, b) {
      let dot=0, na=0, nb=0;
      for (const k of Object.keys(WEIGHTS)) {
        const w=WEIGHTS[k]||1, x=(a[k]||0)*w, y=(b[k]||0)*w;
        dot += x*y; na += x*x; nb += y*y;
      }
      return dot / (Math.sqrt(na||1)*Math.sqrt(nb||1));
    }

    /* =========================
       결과 코멘트 자동 생성
    ========================== */
    function buildAdvice(axes) {
      const tips = [];
      if ((axes.leglock||0) >= 8) tips.push("레그락 체인을 더 깊게: 엔트리 다양화 + 반엔트리 방어 루틴.");
      if ((axes.berimbolo||0) >= 8) tips.push("베림보로 전개시 백 컨트롤 전환 각도 반복 연습.");
      if ((axes.control||0) >= 8) tips.push("마운트/백 유지 후 서브미션 전환을 표준 루틴으로 고정.");
      if ((axes.pressure||0) >= 8) tips.push("바디락/프레셔 패스 후 사이드→마운트 연결 디테일.");
      if ((axes.wrestling||0) >= 8) tips.push("레슬 엔트리에서 가드 리텐션 케어(스냅다운→백/다스).");
      if ((axes.scramble||0) >= 8) tips.push("하이 템포 유지 시, 리스크 관리용 프레임·리커버리 루틴.");
      if ((axes.fundamental||0) >= 8) tips.push("기본기 콤보(암바/삼각/초크) 상황별 3가지 루트 고정.");
      if ((axes.mental||0) >= 8) tips.push("상대 스타일별 A/B 플랜 카드 준비.");
      if (!tips.length) tips.push("균형형 스타일: 약한 축 하나 골라 집중 보완 루틴을 만들자.");
      return tips;
    }

    /* =========================
       공유 링크 & 버튼 헬퍼
    ========================== */
    function buildShareURL(platform, text, url) {
      const t = encodeURIComponent(text), u = encodeURIComponent(url);
      if (platform === "line")     return `https://line.me/R/msg/text/?${t}%20${u}`;
      if (platform === "whatsapp") return `https://api.whatsapp.com/send?text=${t}%20${u}`;
      if (platform === "facebook") return `https://www.facebook.com/sharer/sharer.php?u=${u}`;
      if (platform === "telegram") return `https://t.me/share/url?url=${u}&text=${t}`;
      if (platform === "sms")      return `sms:?&body=${t}%20${u}`;
      if (platform === "x")        return `https://twitter.com/intent/tweet?text=${t}&url=${u}`;
      return url;
    }

    /* =========================
       메인 앱
    ========================== */
    function App() {
      const [lang, setLang] = useState(detectLang());
      const t = STR[lang] || STR.en;

      const [step, setStep] = useState("intro");
      const [qIdx, setQIdx] = useState(0);
      const [answers, setAnswers] = useState([]);
      const [shared, setShared] = useState(null);

      useEffect(()=>{
        const r = new URLSearchParams(location.search).get("r");
        if (r) { try { const j = JSON.parse(atob(r)); if (j?.axes) { setShared(j); setStep("result"); } } catch(e){} }
      },[]);

      const axes = useMemo(()=>{
        const acc = Object.fromEntries(AXES.map(ax=>[ax.key,0]));
        (shared?.axes
          ? Object.entries(shared.axes).forEach(([k,v])=>acc[k]=v)
          : answers.forEach(a=>{ const q=QUESTIONS.find(x=>x.id===a.id); if(q) acc[q.axis]=a.val; }));
        return acc;
      }, [answers, shared]);

      const winner = useMemo(()=>{
        let best=null, score=-1;
        for (const at of ATHLETES) {
          const sim = weightedCosine(axes, PROFILES[at.id]);
          if (sim > score) { score = sim; best = at; }
        }
        return { at: best, sim: score };
      }, [JSON.stringify(axes)]);

      function pick(val) {
        const q = QUESTIONS[qIdx];
        const next = answers.filter(a=>a.id!==q.id).concat({id:q.id, val});
        setAnswers(next);
      }

      return (
        <div className="max-w-5xl mx-auto px-4 py-10">
          <header className="text-center mb-8">
            <h1 className="text-3xl md:text-5xl font-extrabold tracking-tight">{t.title}</h1>
            <p className="text-gray-600 mt-2">{t.subtitle}</p>
          </header>

          <main className="rounded-3xl shadow-xl bg-white p-6 md:p-10 glass">
            {step==="intro" && (
              <div className="text-center">
                <div className="mt-3 inline-flex items-center gap-2 text-sm text-gray-500">
                  <span>Language</span>
                  <select className="border rounded-xl px-3 py-2" value={lang} onChange={(e)=>setLang(e.target.value)}>
                    {Object.keys(STR).map(k=>(<option key={k} value={k}>{k}</option>))}
                  </select>
                </div>
                <button className="mt-6 md:mt-8 px-6 py-3 rounded-2xl bg-black text-white hover:opacity-90 transition"
                        onClick={()=>setStep("quiz")}>{t.start}</button>
              </div>
            )}

            {step==="quiz" && (
              <Quiz
                lang={lang} t={t}
                qIdx={qIdx} setQIdx={setQIdx}
                answers={answers} pick={pick}
                onSubmit={()=>setStep("result")}
              />
            )}

            {step==="result" && winner?.at && (
              <Result
                lang={lang} t={t}
                axes={axes} winner={winner.at}
                onRestart={()=>{ setStep("intro"); setQIdx(0); setAnswers([]); setShared(null); }}
              />
            )}

            <p className="text-xs text-gray-400 mt-6">* 이미지가 막힐 때를 대비해 플레이스홀더가 자동 표시됩니다. 카카오 전용 버튼은 도메인 등록+JS 키 필요.</p>
          </main>
        </div>
      );
    }

    function Quiz({ t, lang, qIdx, setQIdx, answers, pick, onSubmit }) {
      const total = QUESTIONS.length;
      const q = QUESTIONS[qIdx];
      const picked = answers.find(a=>a.id===q.id)?.val;

      const pct = Math.round(((qIdx+1)/total)*100);

      return (
        <div>
          <div className="w-full">
            <div className="flex justify-between text-sm text-gray-500 mb-1"><span>Q{qIdx+1}</span><span>{pct}%</span></div>
            <div className="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
              <div className="h-full bg-black/80" style={{width: pct+'%'}}/>
            </div>
          </div>

          <h2 className="text-xl md:text-2xl font-bold mt-6">{q.text[lang] || q.text.en}</h2>
          <div className="grid gap-3 mt-4">
            {q.options.map((opt,i)=>(
              <button key={i} onClick={()=>pick(opt.val)}
                className={"text-left border rounded-2xl p-4 transition " + (picked===opt.val ? "border-black bg-black text-white" : "border-gray-200 hover:border-black")}>
                {opt.label[lang] || opt.label.en}
              </button>
            ))}
          </div>

          <div className="flex justify-between mt-6">
            <button className="px-4 py-2 rounded-xl border border-gray-300" onClick={()=>setQIdx(i=>Math.max(0,i-1))} disabled={qIdx===0}>{t.prev}</button>
            {qIdx < total-1 ? (
              <button className="px-4 py-2 rounded-xl bg-black text-white" onClick={()=>setQIdx(i=>Math.min(total-1,i+1))} disabled={!picked}>{t.next}</button>
            ) : (
              <button className="px-4 py-2 rounded-xl bg-black text-white" onClick={onSubmit} disabled={!picked}>{t.submit}</button>
            )}
          </div>
        </div>
      );
    }

    function Result({ t, lang, axes, winner, onRestart }) {
      const labels = AXES.map(ax => ax.label[lang] || ax.label.en);
      const dataVals = AXES.map(ax => Math.max(0, Math.min(10, axes[ax.key]||0)));
      const canvasRef = useRef(null);
      const chartRef = useRef(null);

      useEffect(()=>{
        const ctx = canvasRef.current.getContext('2d');
        if (chartRef.current) chartRef.current.destroy();
        chartRef.current = new Chart(ctx, {
          type:'radar',
          data:{ labels, datasets:[{ label:'0–10', data:dataVals, fill:true, backgroundColor:'rgba(0,0,0,0.12)', borderColor:'rgba(0,0,0,0.85)', pointBackgroundColor:'rgba(0,0,0,0.85)' }]},
          options:{ responsive:true, scales:{ r:{ suggestedMin:0, suggestedMax:10, ticks:{stepSize:2}, grid:{color:'rgba(0,0,0,0.08)'}, angleLines:{color:'rgba(0,0,0,0.08)'}, pointLabels:{color:'#111'} }}, plugins:{legend:{display:false}} }
        });
        return ()=>{ if(chartRef.current) chartRef.current.destroy(); };
      }, [JSON.stringify(axes), lang]);

      // 결과 URL
      const payload = { axes, winner: winner?.id, ts: Date.now() };
      const url = location.origin + location.pathname + "?lang=" + lang + "&r=" + btoa(JSON.stringify(payload));
      const text = (STR[lang]?.title || STR.en.title) + " — " + (winner?.name || "");

      const SHARE = {
        line:      buildShareURL("line", text, url),
        whatsapp:  buildShareURL("whatsapp", text, url),
        facebook:  buildShareURL("facebook", text, url),
        telegram:  buildShareURL("telegram", text, url),
        x:         buildShareURL("x", text, url),
        sms:       buildShareURL("sms", text, url),
      };

      function shareKakao() {
        try {
          if (window.Kakao && !window.Kakao.isInitialized()) {
            // 본인 JS 키로 교체하면 카카오 전용 버튼 활성화됨.
            window.Kakao.init("YOUR_KAKAO_JAVASCRIPT_KEY");
          }
          if (window.Kakao?.Share) {
            window.Kakao.Share.sendDefault({
              objectType:'feed',
              content:{
                title: STR[lang]?.title || STR.en.title,
                description: winner?.name || "",
                imageUrl: "https://upload.wikimedia.org/wikipedia/commons/0/0e/Gordon_Ryan_2019.jpg",
                link: { mobileWebUrl: url, webUrl: url }
              },
              buttons:[{ title: STR[lang]?.submit || STR.en.submit, link:{ mobileWebUrl:url, webUrl:url } }]
            });
            return;
          }
        } catch(e){}
        navigator.clipboard?.writeText(url);
        alert((STR[lang]?.kakaoTip || STR.en.kakaoTip) + "\n" + (STR[lang]?.copied || STR.en.copied));
      }

      function shareNative() {
        if (navigator.share) {
          navigator.share({ title: document.title, text: 'BJJ Style', url }).catch(()=>{});
        } else {
          navigator.clipboard?.writeText(url);
          alert(STR[lang]?.copied || STR.en.copied);
        }
      }

      function copyLink() {
        navigator.clipboard?.writeText(url);
        alert(STR[lang]?.copied || STR.en.copied);
      }

      const top3 = useMemo(()=>{
        const arr = Object.keys(PROFILES).map(id=>({ id, sim: weightedCosine(axes, PROFILES[id]) }));
        arr.sort((a,b)=>b.sim-a.sim);
        return arr.slice(0,3);
      }, [JSON.stringify(axes)]);
      const gap = (top3[0]?.sim||0) - (top3[1]?.sim||0);
      const conf = gap>=0.08 ? "높음" : gap>=0.04 ? "중간" : "낮음";

      const advice = buildAdvice(axes);

      return (
        <div>
          <h2 className="text-xl md:text-2xl font-extrabold">{t.yourResult}</h2>

          <div className="grid md:grid-cols-2 gap-6 items-center mt-4">
            <SmartImage srcs={winner.img} alt={winner.name} className="w-full rounded-2xl shadow-md object-cover" />
            <div>
              <h3 className="text-2xl font-bold">{winner.name}</h3>
              <ul className="mt-2 list-disc list-inside text-gray-700">
                {ATHLETES.find(a=>a.id===winner.id).traits.map((tr,i)=>(<li key={i}>{tr}</li>))}
              </ul>
              <p className="mt-3 font-medium">{ATHLETES.find(a=>a.id===winner.id).compliment}</p>

              <div className="mt-2 text-sm text-gray-600">
                유사도 Top3: {top3.map((x,i)=>`${i+1}. ${ATHLETES.find(a=>a.id===x.id)?.name || x.id} (${Math.round(x.sim*100)}%)`).join(' · ')}
                <br/>판정 신뢰도: <span className="font-semibold">{conf}</span> (격차 {Math.round(gap*100)}%)
              </div>

              {/* 공유 영역: a 태그 + onClick 핸들러로 수정 */}
              <div className="mt-4">
                <div className="text-sm text-gray-600 mb-2">{t.shareVia}</div>
                <div className="flex flex-wrap gap-2">
                  <a className="px-3 py-2 rounded-xl bg-[#FEE500] text-black" href="#" onClick={(e)=>{e.preventDefault(); shareKakao();}}>Kakao</a>
                  <a className="px-3 py-2 rounded-xl border" href={SHARE.line} target="_blank" rel="noopener noreferrer">LINE</a>
                  <a className="px-3 py-2 rounded-xl border" href={SHARE.whatsapp} target="_blank" rel="noopener noreferrer">WhatsApp</a>
                  <a className="px-3 py-2 rounded-xl border" href={SHARE.facebook} target="_blank" rel="noopener noreferrer">Facebook</a>
                  <a className="px-3 py-2 rounded-xl border" href={SHARE.telegram} target="_blank" rel="noopener noreferrer">Telegram</a>
                  <a className="px-3 py-2 rounded-xl border" href={SHARE.x} target="_blank" rel="noopener noreferrer">X</a>
                  <a className="px-3 py-2 rounded-xl border" href={SHARE.sms}>SMS</a>
                  <a className="px-3 py-2 rounded-xl bg-black text-white" href="#" onClick={(e)=>{e.preventDefault(); shareNative();}}>Share</a>
                  <a className="px-3 py-2 rounded-xl border" href="#" onClick={(e)=>{e.preventDefault(); copyLink();}}>{t.share}</a>
                </div>
              </div>

              <div className="flex gap-2 mt-4">
                <button className="px-4 py-2 rounded-xl border" onClick={onRestart}>{t.restart}</button>
              </div>
            </div>
          </div>

          <div className="mt-8">
            <h4 className="font-semibold mb-2">스타일 스파이더차트</h4>
            <canvas ref={canvasRef} height="300"></canvas>

            <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
              {AXES.map((ax,i)=>(
                <div key={ax.key} className="flex justify-between border rounded-lg px-3 py-2">
                  <span>{ax.label[lang] || ax.label.en}</span>
                  <span className="font-medium">{Math.round(dataVals[i])}</span>
                </div>
              ))}
            </div>

            <div className="mt-6">
              <h4 className="font-semibold mb-2">추천 포인트</h4>
              <ul className="list-disc list-inside text-gray-700">
                {advice.map((s,i)=>(<li key={i}>{s}</li>))}
              </ul>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
</body>
</html>
